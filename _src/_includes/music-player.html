<!-- Ambient Music Player -->
<div id="music-player" class="fixed bottom-8 left-8 z-[60] opacity-0 translate-y-4 transition-all duration-500">
  <!-- Expanded Player Panel -->
  <div id="music-panel" class="hidden mb-3 bg-navy-900/95 backdrop-blur-xl rounded-2xl shadow-2xl border border-white/10 overflow-hidden w-72">
    <!-- Track Visualizer Header -->
    <div class="relative h-24 bg-gradient-to-br from-gold-500/20 via-purple-500/20 to-blue-500/20 overflow-hidden">
      <div id="music-visualizer" class="absolute inset-0 flex items-end justify-center gap-1 px-4 pb-2">
        <!-- Equalizer bars generated by JS -->
      </div>
      <div class="absolute inset-0 bg-gradient-to-t from-navy-900/90 to-transparent"></div>
      <div class="absolute bottom-2 left-4 right-4">
        <p id="music-track-name" class="text-white font-semibold text-sm truncate">Select an atmosphere</p>
        <p id="music-track-artist" class="text-gray-400 text-xs truncate">Ambient Soundscape</p>
      </div>
    </div>

    <!-- Mood Selector -->
    <div class="p-4 border-b border-white/10">
      <label class="text-gray-400 text-xs block mb-2">Atmosphere</label>
      <select id="music-track-select" class="w-full bg-navy-800 text-white text-sm rounded-lg px-3 py-2.5 border border-white/10 focus:border-gold-500 focus:outline-none cursor-pointer">
        <option value="">Choose your vibe...</option>
        <optgroup label="Calm">
          <option value="peaceful">Peaceful Dreams</option>
          <option value="meditation">Deep Meditation</option>
          <option value="ocean">Ocean Waves</option>
        </optgroup>
        <optgroup label="Focus">
          <option value="focus">Deep Focus</option>
          <option value="ambient">Floating Ambient</option>
          <option value="minimal">Minimal Pulse</option>
        </optgroup>
        <optgroup label="Energy">
          <option value="cinematic">Cinematic Rise</option>
          <option value="dark">Dark Atmosphere</option>
          <option value="pulse">Energy Pulse</option>
        </optgroup>
      </select>
    </div>

    <!-- Playback Controls -->
    <div class="p-4 flex items-center justify-center gap-4">
      <button id="music-play-btn" class="w-14 h-14 rounded-full bg-gold-500 hover:bg-gold-400 text-navy-900 flex items-center justify-center transition transform hover:scale-105 shadow-lg">
        <svg id="music-play-icon" class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"></path>
        </svg>
        <svg id="music-pause-icon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
        </svg>
      </button>
    </div>

    <!-- Volume Control -->
    <div class="px-4 pb-4">
      <div class="flex items-center gap-3">
        <button id="music-mute" class="text-gray-400 hover:text-white transition">
          <svg id="music-volume-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072M18.364 5.636a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
          </svg>
          <svg id="music-mute-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"></path>
          </svg>
        </button>
        <div id="music-volume-container" class="flex-1 h-2 bg-navy-700 rounded-full cursor-pointer relative">
          <div id="music-volume-bar" class="h-full bg-gradient-to-r from-gold-500 to-gold-400 rounded-full transition-all" style="width: 70%"></div>
          <div id="music-volume-handle" class="absolute top-1/2 -translate-y-1/2 w-4 h-4 bg-white rounded-full shadow-lg cursor-grab" style="left: 70%"></div>
        </div>
        <span id="music-volume-value" class="text-gray-400 text-xs w-8">70%</span>
      </div>
    </div>

    <!-- Attribution -->
    <div class="px-4 pb-3 text-center">
      <p class="text-gray-500 text-xs">Generative ambient soundscapes</p>
    </div>
  </div>

  <!-- Floating Toggle Button -->
  <button id="music-toggle" class="relative bg-navy-900/90 hover:bg-navy-800 backdrop-blur-xl text-white p-4 rounded-full shadow-2xl border border-white/10 transition-all duration-300 hover:scale-110 hover:border-gold-500/50 group" style="pointer-events: auto !important; z-index: 9999 !important;">
    <!-- Pulse ring animation when playing -->
    <div id="music-pulse" class="absolute inset-0 rounded-full border-2 border-gold-500/50 animate-ping hidden"></div>

    <!-- Music note icon -->
    <svg id="music-note-icon" class="w-6 h-6 text-gold-400 group-hover:text-gold-300 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
    </svg>

    <!-- Mini equalizer when playing -->
    <div id="music-eq-mini" class="absolute inset-0 flex items-center justify-center gap-0.5 hidden">
      <span class="w-1 h-3 bg-gold-400 rounded-full animate-eq-1"></span>
      <span class="w-1 h-4 bg-gold-400 rounded-full animate-eq-2"></span>
      <span class="w-1 h-2 bg-gold-400 rounded-full animate-eq-3"></span>
      <span class="w-1 h-3 bg-gold-400 rounded-full animate-eq-4"></span>
    </div>

    <!-- New badge for first-time visitors -->
    <span id="music-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-gold-500 rounded-full hidden">
      <span class="absolute inset-0 rounded-full bg-gold-500 animate-ping"></span>
    </span>
  </button>

  <!-- Welcome notification -->
  <div id="music-welcome" class="absolute bottom-full left-0 mb-3 hidden opacity-0 transition-opacity duration-500 w-64">
    <div class="bg-navy-800/95 backdrop-blur-xl rounded-xl p-4 shadow-2xl border border-gold-500/20 relative">
      <div class="absolute -bottom-2 left-6 w-4 h-4 bg-navy-800/95 border-r border-b border-gold-500/20 transform rotate-45"></div>
      <div class="flex items-center gap-2 mb-2">
        <div class="w-8 h-8 rounded-full bg-gold-500/20 flex items-center justify-center">
          <svg class="w-4 h-4 text-gold-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
          </svg>
        </div>
        <span class="text-gold-400 font-semibold text-sm">Enhance Your Experience</span>
      </div>
      <p class="text-gray-300 text-xs leading-relaxed mb-3">
        Enable ambient soundscapes for an immersive browsing experience.
      </p>
      <div class="flex gap-2">
        <button id="music-welcome-play" class="flex-1 bg-gold-500 hover:bg-gold-400 text-navy-900 text-xs font-semibold py-2 px-3 rounded-lg transition transform hover:scale-105">
          Play Music
        </button>
        <button id="music-welcome-dismiss" class="px-3 py-2 text-gray-400 hover:text-white text-xs rounded-lg border border-white/10 hover:border-white/30 transition">
          Later
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Player visibility */
  #music-player.visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Equalizer animations */
  @keyframes eq-1 {
    0%, 100% { height: 4px; }
    50% { height: 16px; }
  }
  @keyframes eq-2 {
    0%, 100% { height: 8px; }
    50% { height: 20px; }
  }
  @keyframes eq-3 {
    0%, 100% { height: 12px; }
    50% { height: 8px; }
  }
  @keyframes eq-4 {
    0%, 100% { height: 6px; }
    50% { height: 14px; }
  }

  .animate-eq-1 { animation: eq-1 0.8s ease-in-out infinite; }
  .animate-eq-2 { animation: eq-2 0.6s ease-in-out infinite 0.1s; }
  .animate-eq-3 { animation: eq-3 0.7s ease-in-out infinite 0.2s; }
  .animate-eq-4 { animation: eq-4 0.5s ease-in-out infinite 0.15s; }

  /* Large visualizer bars */
  .visualizer-bar {
    width: 4px;
    background: linear-gradient(to top, #f59e0b, #fbbf24);
    border-radius: 2px;
    transition: height 0.1s ease;
  }

  /* Track select styling */
  #music-track-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%239ca3af'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
  }

  /* Welcome notification animations */
  #music-welcome.show {
    opacity: 1;
  }

  @keyframes welcome-glow {
    0%, 100% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
    50% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.4); }
  }

  #music-welcome.show > div {
    animation: welcome-glow 2s ease-in-out infinite;
  }
</style>

<script>
(function() {
  'use strict';

  // ===== CLEAR OLD CACHE =====
  const MUSIC_VERSION = '3';
  if (localStorage.getItem('musicVersion') !== MUSIC_VERSION) {
    localStorage.removeItem('musicTrack');
    localStorage.removeItem('musicEnabled');
    localStorage.removeItem('musicWelcomeSeen');
    localStorage.setItem('musicVersion', MUSIC_VERSION);
  }

  // ===== MOOD PRESETS =====
  const MOODS = {
    'peaceful': { name: 'Peaceful Dreams', type: 'pad', baseFreq: 220, color: 'warm' },
    'meditation': { name: 'Deep Meditation', type: 'drone', baseFreq: 110, color: 'deep' },
    'ocean': { name: 'Ocean Waves', type: 'noise', baseFreq: 0, color: 'cool' },
    'focus': { name: 'Deep Focus', type: 'binaural', baseFreq: 200, color: 'neutral' },
    'ambient': { name: 'Floating Ambient', type: 'pad', baseFreq: 330, color: 'ethereal' },
    'minimal': { name: 'Minimal Pulse', type: 'pulse', baseFreq: 55, color: 'minimal' },
    'cinematic': { name: 'Cinematic Rise', type: 'swell', baseFreq: 165, color: 'epic' },
    'dark': { name: 'Dark Atmosphere', type: 'dark', baseFreq: 82, color: 'dark' },
    'pulse': { name: 'Energy Pulse', type: 'pulse', baseFreq: 110, color: 'energy' }
  };

  // Map page ambient:music meta tags to our moods
  const PAGE_MOOD_MAP = {
    'classical-peaceful': 'peaceful',
    'classical-dramatic': 'cinematic',
    'classical-baroque': 'ambient',
    'electronic-ambient': 'ambient',
    'electronic-chill': 'focus',
    'electronic-dark': 'dark',
    'acoustic-guitar': 'peaceful',
    'acoustic-jazz': 'minimal',
    'cinematic-tension': 'dark',
    'cinematic-inspiring': 'cinematic'
  };

  // ===== STATE =====
  let audioContext = null;
  let masterGain = null;
  let nodes = [];
  let isPlaying = false;
  let currentMoodId = null;
  let volume = 0.7;
  let animationId = null;
  let analyser = null;

  // ===== DOM ELEMENTS =====
  const player = document.getElementById('music-player');
  if (!player) return;

  const panel = document.getElementById('music-panel');
  const toggleBtn = document.getElementById('music-toggle');
  const playBtn = document.getElementById('music-play-btn');
  const playIcon = document.getElementById('music-play-icon');
  const pauseIcon = document.getElementById('music-pause-icon');
  const trackSelect = document.getElementById('music-track-select');
  const trackName = document.getElementById('music-track-name');
  const trackArtist = document.getElementById('music-track-artist');
  const volumeBar = document.getElementById('music-volume-bar');
  const volumeHandle = document.getElementById('music-volume-handle');
  const volumeContainer = document.getElementById('music-volume-container');
  const volumeValue = document.getElementById('music-volume-value');
  const muteBtn = document.getElementById('music-mute');
  const volumeIcon = document.getElementById('music-volume-icon');
  const muteIcon = document.getElementById('music-mute-icon');
  const visualizer = document.getElementById('music-visualizer');
  const pulse = document.getElementById('music-pulse');
  const noteIcon = document.getElementById('music-note-icon');
  const eqMini = document.getElementById('music-eq-mini');
  const welcomeEl = document.getElementById('music-welcome');
  const welcomePlayBtn = document.getElementById('music-welcome-play');
  const welcomeDismissBtn = document.getElementById('music-welcome-dismiss');
  const musicBadge = document.getElementById('music-badge');

  // ===== PERSISTENCE =====
  function setMusicEnabled(enabled) {
    localStorage.setItem('musicEnabled', enabled ? 'true' : 'false');
  }

  function isMusicEnabled() {
    return localStorage.getItem('musicEnabled') === 'true';
  }

  // ===== WELCOME NOTIFICATION =====
  function showWelcome() {
    const hasSeenWelcome = localStorage.getItem('musicWelcomeSeen');
    if (hasSeenWelcome) return;
    if (musicBadge) musicBadge.classList.remove('hidden');
    setTimeout(() => {
      if (welcomeEl && !isPlaying) {
        welcomeEl.classList.remove('hidden');
        setTimeout(() => welcomeEl.classList.add('show'), 50);
      }
    }, 3000);
  }

  function hideWelcome(permanent = false) {
    if (welcomeEl) {
      welcomeEl.classList.remove('show');
      setTimeout(() => welcomeEl.classList.add('hidden'), 500);
    }
    if (musicBadge) musicBadge.classList.add('hidden');
    if (permanent) {
      localStorage.setItem('musicWelcomeSeen', 'true');
    }
  }

  // ===== AUDIO SYNTHESIS =====
  function initAudio() {
    if (audioContext) return;
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioContext.createGain();
    masterGain.gain.value = volume;
    masterGain.connect(audioContext.destination);

    // Create analyser for visualizer
    analyser = audioContext.createAnalyser();
    analyser.fftSize = 64;
    masterGain.connect(analyser);
  }

  function stopAllNodes() {
    nodes.forEach(node => {
      try {
        if (node.stop) node.stop();
        if (node.disconnect) node.disconnect();
      } catch (e) {}
    });
    nodes = [];
  }

  function createPadSound(baseFreq, color) {
    const osc1 = audioContext.createOscillator();
    const osc2 = audioContext.createOscillator();
    const osc3 = audioContext.createOscillator();
    const gain1 = audioContext.createGain();
    const gain2 = audioContext.createGain();
    const gain3 = audioContext.createGain();
    const filter = audioContext.createBiquadFilter();

    // Frequencies for chord
    const freqs = color === 'warm' ? [baseFreq, baseFreq * 1.25, baseFreq * 1.5] :
                  color === 'ethereal' ? [baseFreq, baseFreq * 1.2, baseFreq * 1.498] :
                  [baseFreq, baseFreq * 1.189, baseFreq * 1.498];

    osc1.frequency.value = freqs[0];
    osc2.frequency.value = freqs[1];
    osc3.frequency.value = freqs[2];

    osc1.type = 'sine';
    osc2.type = 'sine';
    osc3.type = 'triangle';

    gain1.gain.value = 0.3;
    gain2.gain.value = 0.2;
    gain3.gain.value = 0.1;

    filter.type = 'lowpass';
    filter.frequency.value = 800;
    filter.Q.value = 1;

    osc1.connect(gain1);
    osc2.connect(gain2);
    osc3.connect(gain3);
    gain1.connect(filter);
    gain2.connect(filter);
    gain3.connect(filter);
    filter.connect(masterGain);

    // Slow LFO for movement
    const lfo = audioContext.createOscillator();
    const lfoGain = audioContext.createGain();
    lfo.frequency.value = 0.1;
    lfoGain.gain.value = 30;
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);

    osc1.start();
    osc2.start();
    osc3.start();
    lfo.start();

    nodes.push(osc1, osc2, osc3, lfo);
  }

  function createDroneSound(baseFreq) {
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    const filter = audioContext.createBiquadFilter();

    osc.frequency.value = baseFreq;
    osc.type = 'sawtooth';
    gain.gain.value = 0.15;
    filter.type = 'lowpass';
    filter.frequency.value = 400;

    osc.connect(gain);
    gain.connect(filter);
    filter.connect(masterGain);

    // Add subtle beating
    const osc2 = audioContext.createOscillator();
    const gain2 = audioContext.createGain();
    osc2.frequency.value = baseFreq + 1;
    osc2.type = 'sawtooth';
    gain2.gain.value = 0.15;
    osc2.connect(gain2);
    gain2.connect(filter);

    osc.start();
    osc2.start();
    nodes.push(osc, osc2);
  }

  function createNoiseSound() {
    const bufferSize = 2 * audioContext.sampleRate;
    const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
    const output = noiseBuffer.getChannelData(0);

    for (let i = 0; i < bufferSize; i++) {
      output[i] = Math.random() * 2 - 1;
    }

    const noise = audioContext.createBufferSource();
    noise.buffer = noiseBuffer;
    noise.loop = true;

    const filter = audioContext.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 400;

    const gain = audioContext.createGain();
    gain.gain.value = 0.3;

    // LFO for wave-like movement
    const lfo = audioContext.createOscillator();
    const lfoGain = audioContext.createGain();
    lfo.frequency.value = 0.08;
    lfoGain.gain.value = 200;
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(masterGain);

    noise.start();
    lfo.start();
    nodes.push(noise, lfo);
  }

  function createBinauralSound(baseFreq) {
    // Left ear
    const oscL = audioContext.createOscillator();
    const gainL = audioContext.createGain();
    const panL = audioContext.createStereoPanner();
    oscL.frequency.value = baseFreq;
    oscL.type = 'sine';
    gainL.gain.value = 0.2;
    panL.pan.value = -1;

    // Right ear (slightly different frequency for binaural effect)
    const oscR = audioContext.createOscillator();
    const gainR = audioContext.createGain();
    const panR = audioContext.createStereoPanner();
    oscR.frequency.value = baseFreq + 10; // 10Hz binaural beat (alpha waves)
    oscR.type = 'sine';
    gainR.gain.value = 0.2;
    panR.pan.value = 1;

    oscL.connect(gainL);
    gainL.connect(panL);
    panL.connect(masterGain);

    oscR.connect(gainR);
    gainR.connect(panR);
    panR.connect(masterGain);

    oscL.start();
    oscR.start();
    nodes.push(oscL, oscR);
  }

  function createPulseSound(baseFreq, color) {
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();

    osc.frequency.value = baseFreq;
    osc.type = 'sine';

    // Pulsing gain
    const lfo = audioContext.createOscillator();
    const lfoGain = audioContext.createGain();
    lfo.frequency.value = color === 'energy' ? 2 : 0.5;
    lfoGain.gain.value = 0.15;

    gain.gain.value = 0.2;
    lfo.connect(lfoGain);
    lfoGain.connect(gain.gain);

    osc.connect(gain);
    gain.connect(masterGain);

    osc.start();
    lfo.start();
    nodes.push(osc, lfo);

    // Add harmonics
    const osc2 = audioContext.createOscillator();
    const gain2 = audioContext.createGain();
    osc2.frequency.value = baseFreq * 2;
    osc2.type = 'sine';
    gain2.gain.value = 0.08;
    osc2.connect(gain2);
    gain2.connect(masterGain);
    osc2.start();
    nodes.push(osc2);
  }

  function createDarkSound(baseFreq) {
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    const filter = audioContext.createBiquadFilter();

    osc.frequency.value = baseFreq;
    osc.type = 'sawtooth';
    gain.gain.value = 0.12;
    filter.type = 'lowpass';
    filter.frequency.value = 300;
    filter.Q.value = 5;

    osc.connect(gain);
    gain.connect(filter);
    filter.connect(masterGain);

    // Slow filter sweep
    const lfo = audioContext.createOscillator();
    const lfoGain = audioContext.createGain();
    lfo.frequency.value = 0.05;
    lfoGain.gain.value = 150;
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);

    osc.start();
    lfo.start();
    nodes.push(osc, lfo);
  }

  function createSwellSound(baseFreq) {
    createPadSound(baseFreq, 'epic');

    // Add rising element
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    osc.frequency.value = baseFreq / 2;
    osc.type = 'triangle';
    gain.gain.value = 0.1;

    osc.connect(gain);
    gain.connect(masterGain);

    // Slow pitch rise
    osc.frequency.setValueAtTime(baseFreq / 2, audioContext.currentTime);
    osc.frequency.linearRampToValueAtTime(baseFreq, audioContext.currentTime + 30);

    osc.start();
    nodes.push(osc);
  }

  function loadMood(moodId) {
    if (!MOODS[moodId]) return;

    initAudio();
    stopAllNodes();

    if (audioContext.state === 'suspended') {
      audioContext.resume();
    }

    const mood = MOODS[moodId];
    currentMoodId = moodId;

    switch (mood.type) {
      case 'pad':
        createPadSound(mood.baseFreq, mood.color);
        break;
      case 'drone':
        createDroneSound(mood.baseFreq);
        break;
      case 'noise':
        createNoiseSound();
        break;
      case 'binaural':
        createBinauralSound(mood.baseFreq);
        break;
      case 'pulse':
        createPulseSound(mood.baseFreq, mood.color);
        break;
      case 'dark':
        createDarkSound(mood.baseFreq);
        break;
      case 'swell':
        createSwellSound(mood.baseFreq);
        break;
    }

    if (trackName) trackName.textContent = mood.name;
    if (trackArtist) trackArtist.textContent = 'Generative Ambient';
    if (trackSelect) trackSelect.value = moodId;
  }

  function play() {
    if (!currentMoodId && trackSelect && trackSelect.value) {
      loadMood(trackSelect.value);
    } else if (!currentMoodId) {
      // Default to ambient
      loadMood('ambient');
    }

    if (audioContext && audioContext.state === 'suspended') {
      audioContext.resume();
    }

    isPlaying = true;
    setMusicEnabled(true);
    updatePlayButton();
    animateVisualizer();
    hideWelcome(true);
  }

  function pause() {
    stopAllNodes();
    isPlaying = false;
    updatePlayButton();
    if (animationId) {
      cancelAnimationFrame(animationId);
      animationId = null;
    }
  }

  function togglePlay() {
    if (isPlaying) {
      pause();
    } else {
      play();
    }
  }

  // ===== UI UPDATES =====
  function updatePlayButton() {
    if (isPlaying) {
      if (playIcon) playIcon.classList.add('hidden');
      if (pauseIcon) pauseIcon.classList.remove('hidden');
      if (pulse) pulse.classList.remove('hidden');
      if (noteIcon) noteIcon.classList.add('hidden');
      if (eqMini) eqMini.classList.remove('hidden');
    } else {
      if (playIcon) playIcon.classList.remove('hidden');
      if (pauseIcon) pauseIcon.classList.add('hidden');
      if (pulse) pulse.classList.add('hidden');
      if (noteIcon) noteIcon.classList.remove('hidden');
      if (eqMini) eqMini.classList.add('hidden');
    }
  }

  function updateVolumeUI() {
    const percent = volume * 100;
    if (volumeBar) volumeBar.style.width = `${percent}%`;
    if (volumeHandle) volumeHandle.style.left = `${percent}%`;
    if (volumeValue) volumeValue.textContent = `${Math.round(percent)}%`;

    if (volume === 0) {
      if (volumeIcon) volumeIcon.classList.add('hidden');
      if (muteIcon) muteIcon.classList.remove('hidden');
    } else {
      if (volumeIcon) volumeIcon.classList.remove('hidden');
      if (muteIcon) muteIcon.classList.add('hidden');
    }
  }

  // ===== VISUALIZER =====
  function createVisualizerBars() {
    if (!visualizer) return;
    visualizer.innerHTML = '';
    for (let i = 0; i < 32; i++) {
      const bar = document.createElement('div');
      bar.className = 'visualizer-bar';
      bar.style.height = '4px';
      visualizer.appendChild(bar);
    }
  }

  function animateVisualizer() {
    if (!isPlaying || !visualizer || !analyser) {
      if (animationId) cancelAnimationFrame(animationId);
      return;
    }

    const bars = visualizer.querySelectorAll('.visualizer-bar');
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(dataArray);

    bars.forEach((bar, i) => {
      const value = dataArray[i] || 0;
      const height = Math.max(4, (value / 255) * 60);
      bar.style.height = `${height}px`;
    });

    animationId = requestAnimationFrame(animateVisualizer);
  }

  // ===== EVENT HANDLERS =====
  function bindEvents() {
    if (toggleBtn && panel) {
      toggleBtn.addEventListener('click', () => {
        panel.classList.toggle('hidden');
        hideWelcome(true);
      });
    }

    if (welcomePlayBtn) {
      welcomePlayBtn.addEventListener('click', () => {
        hideWelcome(true);
        if (panel) panel.classList.remove('hidden');
        const pageMusicMeta = document.querySelector('meta[name="ambient:music"]');
        const pageTrack = pageMusicMeta ? pageMusicMeta.content : null;
        const moodId = PAGE_MOOD_MAP[pageTrack] || 'ambient';
        loadMood(moodId);
        play();
      });
    }

    if (welcomeDismissBtn) {
      welcomeDismissBtn.addEventListener('click', () => {
        hideWelcome(true);
        setMusicEnabled(false);
      });
    }

    if (playBtn) playBtn.addEventListener('click', togglePlay);

    if (trackSelect) {
      trackSelect.addEventListener('change', (e) => {
        if (e.target.value) {
          loadMood(e.target.value);
          play();
        }
      });
    }

    // Volume control
    if (volumeContainer) {
      volumeContainer.addEventListener('click', (e) => {
        const rect = volumeContainer.getBoundingClientRect();
        volume = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        if (masterGain) masterGain.gain.value = volume;
        localStorage.setItem('musicVolume', volume);
        updateVolumeUI();
      });
    }

    if (muteBtn) {
      muteBtn.addEventListener('click', () => {
        volume = volume === 0 ? 0.7 : 0;
        if (masterGain) masterGain.gain.value = volume;
        updateVolumeUI();
      });
    }
  }

  // ===== INITIALIZATION =====
  function init() {
    const pageMusicMeta = document.querySelector('meta[name="ambient:music"]');
    const pageTrack = pageMusicMeta ? pageMusicMeta.content : null;
    const pageMood = PAGE_MOOD_MAP[pageTrack] || 'ambient';

    // Restore volume
    const savedVolume = localStorage.getItem('musicVolume');
    if (savedVolume) {
      volume = parseFloat(savedVolume);
      updateVolumeUI();
    }

    // Set default mood in selector
    if (trackSelect) trackSelect.value = pageMood;

    // Create visualizer
    createVisualizerBars();

    // Check if music was enabled
    const musicWasEnabled = isMusicEnabled();

    // Show player
    setTimeout(() => {
      player.classList.add('visible');

      if (musicWasEnabled) {
        loadMood(pageMood);
        play();
      } else {
        showWelcome();
      }
    }, 1000);

    bindEvents();
  }

  // Start when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
